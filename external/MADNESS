# -*- mode: cmake -*-

###################
# Find MADNESS
###################

find_package(MADNESS COMPONENTS MADworld REQUIRED)

if (MADNESS_FOUND)
  # Print the MADNESS libraries and paths found
  message(STATUS "\tMADNESS_LIBRARIES=${MADNESS_LIBRARIES}")
  message(STATUS "\tMADNESS_INCLUDE_DIR=${MADNESS_INCLUDE_DIR}")

  # sanity check: try compiling a simple program
  list(APPEND CMAKE_REQUIRED_INCLUDES ${MADNESS_INCLUDE_DIR})
  list(APPEND CMAKE_REQUIRED_LIBRARIES ${MADNESS_LIBRARIES})
  CHECK_CXX_SOURCE_COMPILES(
    "
    #include <world/world.h>
    int main(int argc, char** argv) {
      madness::World& world = madness::initialize(argc, argv);
      return 0;
    }
    "  MADNESS_COMPILES)
  if (NOT MADNESS_COMPILES)
    message(FATAL_ERROR "Could not compile MADNESS test program")
  endif()

  include_directories(${MADNESS_INCLUDE_DIR})
elseif(TA_EXPERT)

  message("** MADNESS was not found or explicitly set")
  message("** Downloading and building MADNESS is explicitly disabled in EXPERT mode")

else()

  message("** Will pull MADNESS from ${MADNESS_SVN_URL}")
  
  set(MADNESS_SVN_URL http://m-a-d-n-e-s-s.googlecode.com/svn/local/trunk)
    
  # need to use BLAS_LIBRARIES and LAPACK_LIBRARIES, but need to convert them first to compiler arguments
  include(ConvertLibrariesListToCompilerArgs)
  convert_libs_to_compargs(BLAS_LIBS "${BLAS_LIBRARIES}")
  convert_libs_to_compargs(LAPACK_LIBS "${LAPACK_LIBRARIES}")
  set(LAPACKBLAS_LIBS "${LAPACK_LIBS} ${BLAS_LIBS}")

  if (INTEGER8)
    set (MAD_F77_INT32 no)
  else()
    set (MAD_F77_INT32 yes)
  endif()

  ExternalProject_Add(
    MADNESS
    PREFIX ${EXTERNAL_BUILD_DIR}/madness
    SVN_REPOSITORY ${MADNESS_SVN_URL}
    PATCH_COMMAND aclocal -I ./ && autoconf && autoheader && automake --add-missing
    UPDATE_COMMAND svn updatae -r HEAD --force
    CONFIGURE_COMMAND ${EXTERNAL_BUILD_DIR}/madness/src/madness/configure --prefix=${CMAKE_INSTALL_PREFIX} --with-mpi-thread=multiple --enable-optimal=yes --enable-dependency-tracking --with-fortran-int32=${MAD_F77_INT32} MPICXX=${CMAKE_CXX_COMPILER} CXX=${CMAKE_CXX_COMPILER} LIBS=${LAPACKBLAS_LIBS} CXXFLAGS=${CMAKE_CXX_FLAGS} CPPFLAGS=${CMAKE_CPP_FLAGS} F77=${CMAKE_Fortran_COMPILER} FFLAGS=${CMAKE_Fortran_FLAGS} LDFLAGS=${CMAKE_EXE_LINKER_FLAGS} 
    BUILD_COMMAND make linalg
    INSTALL_COMMAND make install-linalg
  )

  add_dependencies(External MADNESS)
  set(MADNESS_LIBRARIES)
  foreach (_lib MADworld)
    list(APPEND MADNESS_LIBRARIES ${CMAKE_INSTALL_PREFIX}/lib/lib${_lib}.a)
  endforeach()
  message(STATUS "MADNESS_LIBRARIES = ${MADNESS_LIBRARIES}")
  set(MADNESS_INCLUDE_DIR ${CMAKE_INSTALL_PREFIX}/include)

endif()
